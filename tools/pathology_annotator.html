<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathology Image Annotator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        .image-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
        }
        #imageContainer {
            position: relative;
            display: inline-block;
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        #pathologyImage {
            display: block;
            max-width: 100%;
            cursor: crosshair;
        }
        .annotation-box {
            position: absolute;
            border: 2px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
            cursor: move;
            pointer-events: auto;
        }
        .annotation-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        button:hover {
            background: #2563eb;
        }
        .delete-btn {
            background: #ef4444;
        }
        .delete-btn:hover {
            background: #dc2626;
        }
        #output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .annotation-item {
            background: #f0f9ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #3b82f6;
        }
        .annotation-item.selected {
            background: #dbeafe;
            border-left-color: #ef4444;
        }
        h3 {
            margin-top: 0;
            color: #1f2937;
        }
        label {
            font-weight: bold;
            color: #4b5563;
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>üî¨ Pathology Image Annotator</h1>
    <p>Load your WebPath image and click+drag to create annotations for interactive terms.</p>

    <div class="container">
        <!-- Image Panel -->
        <div class="image-panel">
            <label>Image URL:</label>
            <input type="text" id="imageUrl" placeholder="https://webpath.med.utah.edu/...">
            <button onclick="loadImage()">Load Image</button>

            <div id="imageContainer" style="margin-top: 20px;">
                <img id="pathologyImage" src="" alt="Load an image to start">
            </div>

            <p style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                <strong>Instructions:</strong> Click and drag on the image to create annotation boxes.
                Then fill in the details on the right panel.
            </p>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <h3>üìù Current Annotation</h3>

            <label>Case ID:</label>
            <input type="text" id="caseId" placeholder="webpath_cv_001">

            <label>Term (clickable text):</label>
            <input type="text" id="term" placeholder="widely patent lumen">

            <label>Description:</label>
            <textarea id="description" rows="3" placeholder="Brief explanation of this structure"></textarea>

            <button onclick="saveAnnotation()">‚úì Save Annotation</button>
            <button class="delete-btn" onclick="deleteAnnotation()">‚úó Delete Selected</button>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">

            <h3>üìã Saved Annotations (<span id="annotationCount">0</span>)</h3>
            <div id="annotationsList"></div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">

            <h3>üì§ YAML Output</h3>
            <button onclick="generateYAML()">Generate YAML</button>
            <div id="output"></div>
            <button onclick="copyToClipboard()" style="background: #10b981;">üìã Copy to Clipboard</button>
        </div>
    </div>

    <script>
        let annotations = [];
        let currentBox = null;
        let selectedAnnotationIndex = null;
        let isDrawing = false;
        let startX, startY;

        const imageContainer = document.getElementById('imageContainer');
        const pathologyImage = document.getElementById('pathologyImage');

        function loadImage() {
            const url = document.getElementById('imageUrl').value;
            if (!url) {
                alert('Please enter an image URL');
                return;
            }
            pathologyImage.src = url;
            pathologyImage.onload = () => {
                console.log('Image loaded successfully');
                clearAnnotations();
            };
            pathologyImage.onerror = () => {
                alert('Failed to load image. Check the URL.');
            };
        }

        pathologyImage.addEventListener('mousedown', (e) => {
            const rect = pathologyImage.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDrawing = true;

            currentBox = document.createElement('div');
            currentBox.className = 'annotation-box';
            currentBox.style.left = startX + 'px';
            currentBox.style.top = startY + 'px';
            imageContainer.appendChild(currentBox);
        });

        pathologyImage.addEventListener('mousemove', (e) => {
            if (!isDrawing || !currentBox) return;

            const rect = pathologyImage.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const width = currentX - startX;
            const height = currentY - startY;

            currentBox.style.width = Math.abs(width) + 'px';
            currentBox.style.height = Math.abs(height) + 'px';
            currentBox.style.left = (width < 0 ? currentX : startX) + 'px';
            currentBox.style.top = (height < 0 ? currentY : startY) + 'px';
        });

        pathologyImage.addEventListener('mouseup', (e) => {
            if (!isDrawing || !currentBox) return;
            isDrawing = false;

            const width = parseInt(currentBox.style.width);
            const height = parseInt(currentBox.style.height);

            if (width < 10 || height < 10) {
                currentBox.remove();
                currentBox = null;
                return;
            }

            // Save temporary annotation
            const tempAnnotation = {
                x: parseInt(currentBox.style.left),
                y: parseInt(currentBox.style.top),
                width: width,
                height: height,
                term: '',
                description: '',
                element: currentBox
            };

            annotations.push(tempAnnotation);
            selectedAnnotationIndex = annotations.length - 1;

            // Add label
            const label = document.createElement('div');
            label.className = 'annotation-label';
            label.textContent = `Annotation ${annotations.length}`;
            currentBox.appendChild(label);

            // Make clickable
            currentBox.onclick = () => selectAnnotation(annotations.length - 1);

            currentBox = null;
            updateAnnotationsList();
        });

        function saveAnnotation() {
            if (selectedAnnotationIndex === null) {
                alert('Please select or create an annotation first');
                return;
            }

            const term = document.getElementById('term').value;
            const description = document.getElementById('description').value;

            if (!term) {
                alert('Please enter a term');
                return;
            }

            annotations[selectedAnnotationIndex].term = term;
            annotations[selectedAnnotationIndex].description = description;

            // Update label
            const box = annotations[selectedAnnotationIndex].element;
            const label = box.querySelector('.annotation-label');
            label.textContent = term;

            updateAnnotationsList();
            document.getElementById('term').value = '';
            document.getElementById('description').value = '';
        }

        function selectAnnotation(index) {
            selectedAnnotationIndex = index;
            const annotation = annotations[index];

            document.getElementById('term').value = annotation.term || '';
            document.getElementById('description').value = annotation.description || '';

            updateAnnotationsList();
        }

        function deleteAnnotation() {
            if (selectedAnnotationIndex === null) {
                alert('Please select an annotation to delete');
                return;
            }

            annotations[selectedAnnotationIndex].element.remove();
            annotations.splice(selectedAnnotationIndex, 1);
            selectedAnnotationIndex = null;

            document.getElementById('term').value = '';
            document.getElementById('description').value = '';

            updateAnnotationsList();
        }

        function clearAnnotations() {
            annotations.forEach(a => a.element && a.element.remove());
            annotations = [];
            selectedAnnotationIndex = null;
            updateAnnotationsList();
        }

        function updateAnnotationsList() {
            const list = document.getElementById('annotationsList');
            const count = document.getElementById('annotationCount');

            count.textContent = annotations.length;
            list.innerHTML = '';

            annotations.forEach((annotation, index) => {
                const item = document.createElement('div');
                item.className = 'annotation-item' + (index === selectedAnnotationIndex ? ' selected' : '');
                item.onclick = () => selectAnnotation(index);
                item.innerHTML = `
                    <strong>${annotation.term || `Annotation ${index + 1}`}</strong><br>
                    <small style="color: #6b7280;">
                        (${annotation.x}, ${annotation.y}, ${annotation.width}√ó${annotation.height})
                    </small>
                `;
                list.appendChild(item);
            });
        }

        function generateYAML() {
            const caseId = document.getElementById('caseId').value || 'webpath_case_001';
            const imageUrl = document.getElementById('imageUrl').value;

            if (!imageUrl) {
                alert('Please load an image first');
                return;
            }

            let yaml = `---
pathology_case_id: "${caseId}"
pathology_metadata:
  image_url: "${imageUrl}"
  annotations:\n`;

            annotations.forEach(annotation => {
                yaml += `    - term: "${annotation.term || 'unnamed'}"
      description: "${annotation.description || ''}"
      coordinates:
        x: ${annotation.x}
        y: ${annotation.y}
        width: ${annotation.width}
        height: ${annotation.height}\n`;
            });

            yaml += `---\n\n# Your pathology content here...\n`;

            document.getElementById('output').textContent = yaml;
        }

        function copyToClipboard() {
            const output = document.getElementById('output').textContent;
            if (!output) {
                alert('Generate YAML first');
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                alert('‚úì YAML copied to clipboard!');
            });
        }
    </script>
</body>
</html>
